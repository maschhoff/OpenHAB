//Regeln für die Alarmanlage

var aktiv=false

//Alarmanlage manuel aktivieren oder deaktivieren
rule "Manuelle Aktivierung der Alarmanlage"
when Item Alarmanlage_Switch received command
then
    if(Alarmanlage_Switch.state==ON){
        aktiv=true
        logInfo("Alarmanlage.rules", "Alarmanlage aktiv!")
		pushover("Alarmanlage - AKTIVIERT",0)
		if(now.getHourOfDay>Integer::parseInt(Sunset_Number.state.toString)){
			Presence_Simulation_Switch.sendCommand("ON")
		}
    }else{
        aktiv=false
        Alarmanlage_ausloesen_Switch.sendCommand("OFF")
    }
end

//Alarmanlage aktivieren
rule "Aktiviere Alarmanalege Item Matze"
when Item Matze_Away received update ON or 
     Item Jessy_Away received update ON
then
logInfo("Alarmanlage.rules", "Jemand oder beide sind außerhaus: Matze: "+Matze_Away.state.toString+" Jessy: "+Jessy_Away.state.toString)
if(Jessy_Away.state==ON && Matze_Away.state==ON){
    aktiv=true
    Alarmanlage_Switch.sendCommand("ON")
	Erdgeschloss_Switch.sendCommand("OFF")
}
end

//Alarmanlage deaktivieren
rule "Deaktiviere Alarmanalege Item Matze Jessy Away"
when
    Item Matze_Away received update OFF or 
    Item Jessy_Away received update OFF
then
    logInfo("Alarmanlage.rules", "Jemand oder beide sind zuhause: Matze: "+Matze_Away.state.toString+" Jessy: "+Jessy_Away.state.toString)
    aktiv=false
    Alarmanlage_Switch.sendCommand("OFF")
end

//Alarmanlage deaktivieren manuell
rule "Deaktiviere Alarmanalege Item Alarmanlage_Switch"
when
	 Item Alarmanlage_Switch received command OFF
then
    logInfo("Alarmanlage.rules", "Alarmanlage manuell deaktiviert")
    aktiv=false
end


//Fensterkontakte
rule "Fenster auf oder zu"
when Item Kuechenfenster received command opened or
    Item Wohnzimmerfenster_links received command opened or
    Item Kellertuer received command opened or
    Item Wintergartenfenster received command opened or
    Item Schlafzimmerfenster received command opened
then 
    logInfo("Alarmanlage.rules", "Fenster wurde geöffnet")
    if(aktiv==true){
       //Alarmanlage aktivieren
        Alarmanlage_ausloesen_Switch.sendCommand("ON")
    }
end

//Alarmanlage auslösen
rule "Alarmanlage auslösen"
when Item Alarmanlage_ausloesen_Switch received update
then
    if(Alarmanlage_ausloesen_Switch.state==ON){
          logInfo("Alarmanlage.rule", "Alarmanlage wird ausgelöst!")
         //Lampen an Ton an!
        
        CastLRTV_URI.sendCommand("http://10.10.10.2:81/sirene.mp3")
        CastLRBAD_URI.sendCommand("http://10.10.10.2:81/sirene.mp3")
        Fernseher_LautstRke.sendCommand(10)
	    Fernseher_Fernbedienung.sendCommand(PLAY)
        Badezimmer_Fernbedienung.sendCommand(PLAY)
        Thread::sleep(7000)
        Erdgeschloss_Switch.sendCommand("ON")
        //sendNotification("aschhoff@cmais.de", "!!! EINBRUCH !!!")
        //sendNotification("jezzy1983@gmail.com", "!!! EINBRUCH !!!")
		pushover("Alarmanlage - EINBRUCH",2,null,null,"persistent")
    }else{
        Fernseher_Fernbedienung.sendCommand(STOP)
        Badezimmer_Fernbedienung.sendCommand(STOP)
        Fernseher_LautstRke.sendCommand(20)
    }
end

//Lichtspiele beginnen
rule "Zeitschaltung Lichtspiele an" // Um 17:10 Uhr Lichter anmachen
when Item Presence_Simulation_Switch received update ON
then
if(aktiv==true){
  Gemuetlich_Switch.sendCommand(ON)
    Kueche_Switch.sendCommand(ON)
    Thread::sleep(2000000)
    Schlafzimmer_Helligkeit.sendCommand(100)
    Thread::sleep(6000000)
    Schlafzimmer_Helligkeit.sendCommand(0)
    Thread::sleep(4000000)
    Kueche_Switch.sendCommand(OFF)
    Thread::sleep(4000000)
    Schlafzimmer_Helligkeit.sendCommand(100)
    Thread::sleep(6000000)
    TV_Switch.sendCommand(ON)
    Thread::sleep(3000000)
    TV_Switch.sendCommand(OFF)
    Gemuetlich_Switch.sendCommand(ON)
    Thread::sleep(3000000)
    Schlafzimmer_Helligkeit.sendCommand(70)
}
end


//Beide weg und es wird dunkel - Lichtspiele beginnen
rule "Zeitschaltung Lichtspiele an" // Um 17:10 Uhr Lichter anmachen
when Time cron "0 0/10 17 * * ?" // http://www.quartz-scheduler.org/documentation/quartz-2.x/tutorials/crontrigger.html
then
if(aktiv==true){
  Presence_Simulation_Switch.sendCommand("ON")
}
end


rule "Zeitschaltung Lichtspiele aus"
when Time cron "0 0/29 22 * * ?" // http://www.quartz-scheduler.org/documentation/quartz-2.x/tutorials/crontrigger.html
then
if(aktiv==true){
    DeskLamp.sendCommand("off")
    Schlafzimmer_Helligkeit.sendCommand(0)
    Kueche_Switch.sendCommand(0)
}
end